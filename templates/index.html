<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electro Sur Este - Procesamiento Masivo</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0054a6; --accent: #f7941d; --bg: #f4f6f8; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; color: #333; }
        
        header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; }
        
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Controles */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; background: #eef2f6; padding: 15px; border-radius: 6px; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status-bar { flex: 1; text-align: right; font-weight: bold; color: var(--primary); }

        /* Tabla */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: var(--primary); color: white; }
        tr:hover { background-color: #f9f9f9; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; }
        .badge-yes { background: #d4edda; color: #155724; }
        .badge-no { background: #f8d7da; color: #721c24; }
        .reading-val { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        
        /* Modal / Visualizador */
        .visuals-row { display: none; background: #f1f1f1; }
        .visuals-container { display: flex; gap: 20px; padding: 15px; justify-content: center; }
        .v-card { text-align: center; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .v-card img { max-height: 200px; max-width: 100%; border: 1px solid #ccc; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>Electro Sur Este</h1>
        <small>Sistema de Validación Masiva de Lecturas</small>
    </div>
    <div>API v2.1</div>
</header>

<div class="container">
    <div class="controls">
        <input type="file" id="fileInput" multiple accept="image/*">
        <button class="btn" onclick="startBatchProcessing()" id="btnProcess">Procesar Lote</button>
        <div class="status-bar" id="statusBar">Esperando imágenes...</div>
    </div>

    <table id="resultsTable">
        <thead>
            <tr>
                <th>Archivo</th>
                <th>Estado Display</th>
                <th>Lectura</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
</div>

<script>
    async function startBatchProcessing() {
        const input = document.getElementById('fileInput');
        const btn = document.getElementById('btnProcess');
        const status = document.getElementById('statusBar');
        const tbody = document.getElementById('tableBody');

        if (input.files.length === 0) {
            alert("Selecciona al menos una imagen.");
            return;
        }

        btn.disabled = true;
        tbody.innerHTML = ""; // Limpiar tabla anterior
        let processed = 0;
        let total = input.files.length;

        // Procesar UNA POR UNA (Cola)
        for (const file of input.files) {
            status.innerText = `Procesando ${processed + 1} de ${total}: ${file.name}...`;
            
            try {
                // Crear fila temporal
                const rowId = `row-${processed}`;
                const tr = document.createElement('tr');
                tr.id = rowId;
                tr.innerHTML = `
                    <td>${file.name}</td>
                    <td><span class="badge" style="background:#eee">...</span></td>
                    <td>...</td>
                    <td></td>
                `;
                tbody.appendChild(tr);

                // Preparar envío
                const formData = new FormData();
                formData.append('image', file);
                formData.append('include_visuals', 'true'); // ¡IMPORTANTE! La web pide visuales

                const res = await fetch('/detect', { method: 'POST', body: formData });
                const data = await res.json();

                // Actualizar Fila
                const displayBadge = data.display_detected 
                    ? '<span class="badge badge-yes">DETECTADO</span>' 
                    : '<span class="badge badge-no">NO DETECTADO</span>';
                
                const readingStyle = data.display_detected ? 'reading-val' : 'text-muted';

                // Botón para ver detalles (solo si hubo display y devolvió imágenes)
                let actionBtn = '-';
                if (data.display_detected && data.debug_warp) {
                    actionBtn = `<button class="btn" style="padding: 5px 10px; font-size:0.8rem;" onclick="toggleVisuals('${rowId}', '${data.debug_original}', '${data.debug_warp}')">Ver Detalles</button>`;
                }

                tr.innerHTML = `
                    <td>${data.filename}</td>
                    <td>${displayBadge}</td>
                    <td><span class="${readingStyle}">${data.reading}</span></td>
                    <td>${actionBtn}</td>
                `;

                // Fila oculta para las imágenes
                const trVisual = document.createElement('tr');
                trVisual.id = `${rowId}-vis`;
                trVisual.className = 'visuals-row';
                trVisual.innerHTML = `
                    <td colspan="4">
                        <div class="visuals-container" id="${rowId}-container"></div>
                    </td>
                `;
                tbody.appendChild(trVisual);

            } catch (err) {
                console.error(err);
            }

            processed++;
        }

        status.innerText = `Proceso finalizado. ${total} imágenes analizadas.`;
        btn.disabled = false;
    }

    function toggleVisuals(rowId, imgOriginal, imgWarp) {
        const row = document.getElementById(`${rowId}-vis`);
        const container = document.getElementById(`${rowId}-container`);
        
        if (row.style.display === 'table-row') {
            row.style.display = 'none';
        } else {
            // Renderizar imágenes solo al abrir
            container.innerHTML = `
                <div class="v-card">
                    <h4>Detección Global</h4>
                    <img src="data:image/jpeg;base64,${imgOriginal}">
                </div>
                <div class="v-card">
                    <h4>Lectura (Warp)</h4>
                    <img src="data:image/jpeg;base64,${imgWarp}">
                </div>
            `;
            row.style.display = 'table-row';
        }
    }
</script>

</body>
</html>
